/*==============================================================================
    システム周期タイマ処理 [systm.c]
  
 -------------------------------------------------------------------------------
  << REVISION HISTORY >>
  2020/xx/xx        matekai
  Initial Release
  
==============================================================================*/

#define SYSTM_EXTERN

/*=====================================
  include
=====================================*/
#include "common.h"
#include "timer.h"
#include "pccom_send.h"
#include "systm.h"

#include "debug.h"


/*=====================================
  define
=====================================*/


/*=====================================
  typedef
=====================================*/


/*=====================================
  static argument
=====================================*/
static U32 systm_cnt ;

/*=====================================
  function prototype
=====================================*/


/*=====================================
  global function
=====================================*/

/*==============================================================================
  システムタイマ用割り込みハンドラ処理関数
  void systm_intr( void )
  
 -------------------------------------------------------------------------------
  << Usage >>
  [ IN ]
     なし
  
  [ OUT ]
    なし
==============================================================================*/
void systm_intr( void )
{
	/* TM2割り込み要因をクリア */
	stm32_tim2_clrint( ) ;
	/* タイマカウンタを更新 */
	systm_cnt = ( systm_cnt + 1 ) % 1000000000UL;
	/* UART定期送信 */
	pccom_send_cycle( ) ;
	/* debug code */
	if( ( systm_cnt % 2000 ) == 0 )
	{
		debug_led_on( ) ;
	}
	else if( ( systm_cnt % 2000 ) == 1000 )
	{
		debug_led_off( ) ;
	}
	/* debug end */

	return ;
}

/*==============================================================================
  システムタイマカウント値取得関数
  U32 systm_getcnt( void )

 -------------------------------------------------------------------------------
  << Usage >>
  [ IN ]
     なし

  [ OUT ]
    カウント値
==============================================================================*/
U32 systm_getcnt( void )
{
	U32 ret ;
	/* 念のため割り込み禁止にして今のカウント値を取得 */
	DISABLE_INT ;
	ret = systm_cnt ;
	/* 割り込み再許可 */
	ENABLE_INT ;

	return ret ;
}

/*==============================================================================
  システムタイマカウント値クリア関数
  void systm_clrcnt( void )

 -------------------------------------------------------------------------------
  << Usage >>
  [ IN ]
     なし

  [ OUT ]
    なし
==============================================================================*/
void systm_clrcnt( void )
{
	/* 割り込み禁止にして今のカウント値を0に再設定 */
	DISABLE_INT ;
	systm_cnt = 0U ;
	/* 割り込み再許可 */
	ENABLE_INT ;

	return ;
}

/*==============================================================================
  システムタイマ 変数初期化関数
  void systm_init_ram( void )

 -------------------------------------------------------------------------------
  << Usage >>
  [ IN ]
     なし

  [ OUT ]
    なし
==============================================================================*/
void systm_init_ram( void )
{
	systm_cnt = 0 ;

	return ;
}
/*=====================================
  local function
=====================================*/
/*==============================================================================
  xxxxxx処理関数
  void hoge( void )
  
 -------------------------------------------------------------------------------
  << Usage >>
  [ IN ]
  
  
  [ OUT ]
  
==============================================================================*/


