/*==============================================================================
  STM32F4xx 汎用タイマ処理 [timer.c]
  
 -------------------------------------------------------------------------------
  << REVISION HISTORY >>
  2020/xx/xx        matekai
  Initial Release
 -------------------------------------------------------------------------------
  << Usage >>
  TIM2: 1ms周期生成タイマ( CLK_INT = 16MHz, PSC = 16分周, CNT = 1000 )
  TIM3: 未使用
  TIM4: 未使用
  TIM5: 未使用
  
==============================================================================*/

#define TIMER_EXTERN

/*=====================================
  include
=====================================*/
#include "common.h"
#include "timer.h"
#include "iodefine.h"


/*=====================================
  define
=====================================*/

/*=====================================
  typedef
=====================================*/


/*=====================================
  static argument
=====================================*/


/*=====================================
  function prototype
=====================================*/


/*=====================================
  global function
=====================================*/

/*==============================================================================
  TIM2 初期化処理関数
  void stm32_tim2_init( void )
  
 -------------------------------------------------------------------------------
  << Usage >>
  [ IN ]
  None
  
  [ OUT ]
  None
  
==============================================================================*/
void stm32_tim2_init( void )
{
	/* CEN = 0として、タイマ停止 */
	TIM2_CR1 = 0x0000U ;
	/* プリスケーラ設定(16分周) */
	TIM2_PSC = 15U ;
	/* 閾値の設定(1000CNTで割り込み = 1ms周期割り込み) */
	TIM2_ARR = 999U ;
	/* 念のためカウンタを初期化 */
	TIM2_CNT = 0U ;
	/* 更新割り込み有効 */
	TIM2_DIER = 0x0001U ;
	/* CKD  = 00
	 * ARPE = 0
	 * CMS  = 00
	 * DIR  = 0(アップカウンタ)
	 * OPM  = 0(連続カウント)
	 * URS  = 1(カウンタオーバーフローのみ更新要求生成)
	 * UDIS = 0(更新有効)
	 * CEN  = 0(カウント無効) */
	TIM2_CR1 = 0x0004U ;

	return ;
}

/*==============================================================================
  TIM2 カウント開始処理関数
  void stm32_tim2_start( void )

 -------------------------------------------------------------------------------
  << Usage >>
  [ IN ]
  None

  [ OUT ]
  None

==============================================================================*/
void stm32_tim2_start( void )
{
	/* 割り込み禁止 */
	DISABLE_INT ;
	/* 割り込み要因ステータスを全クリア */
	TIM2_SR = 0x0000U ;
	/* TIM2_CR1.CEN = 1として、カウント開始 */
	TIM2_CR1 |= 0x0001U ;
	/* 割り込み許可 */
	ENABLE_INT ;

	return ;
}

/*==============================================================================
  TIM2 カウント停止処理関数
  void stm32_tim2_stop( void )

 -------------------------------------------------------------------------------
  << Usage >>
  [ IN ]
  None

  [ OUT ]
  None

==============================================================================*/
void stm32_tim2_stop( void )
{
	/* 割り込み禁止 */
	DISABLE_INT ;
	/* TIM2_CR1.CEN = 0として、カウント停止 */
	TIM2_CR1 &= 0xFFFEU ;
	/* 割り込み許可 */
	ENABLE_INT ;

	return ;
}

/*==============================================================================
  TIM2 割り込み要因クリア処理関数
  void stm32_tim2_clrint( void )

 -------------------------------------------------------------------------------
  << Usage >>
  [ IN ]
  None

  [ OUT ]
  None

==============================================================================*/
void stm32_tim2_clrint( void )
{
	/* 割り込み禁止 */
	DISABLE_INT ;
	/* TIM2_SR.UIF = 0として、更新割り込み要因をクリア */
	TIM2_SR &= 0xFFFEU ;
	/* 割り込み許可 */
	ENABLE_INT ;

	return ;
}

/*=====================================
  local function
=====================================*/



